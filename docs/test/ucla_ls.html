<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <title>My experiment</title>
    <script src="../dist/jspsych.js"></script>
    <!-- survey plugins -->
    <script src="../dist/plugin-survey-multi-choice.js"></script>
    <script src="../dist/plugin-survey-likert.js"></script>
    <script src="../dist/plugin-survey-html-form.js"></script>
    <script src="../dist/plugin-survey-text.js"></script>

    <!-- misc plugins -->
    <script src="../dist/plugin-html-keyboard-response.js"></script> 
    
    <link rel="stylesheet" href="../dist/jspsych.css" />

    <style>
      .instruction {
          max-width: 40rem; 
          text-align: justify;
      }

      h2 {
        font-size: 1.5em;
        font-weight: bold;
        background-color: #c0e9ff;
        margin: 1em 0;
      }

      body {
        overflow-y: scroll; /* スクロールを有効にする */
      }
      
    </style>

  </head>
  <body></body>
    <script>

      var jsPsych = initJsPsych({
        on_finish: function() {
          var data = jsPsych.data.get().csv();
          var encodedUri = encodeURI("data:text/csv;charset=utf-8," + data);
          var link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "survey_results.csv");
          document.body.appendChild(link);
          link.click();
        }
      });

      // Page 1:被験者IDの入力 
      var survey_id = {
        type: jsPsychSurveyHtmlForm,
        html: `
        <div class="instruction">
        <h2>識別用コードを入力してください。</h2>
            あなたに割り当てられたID：<input name="participant_id" type="text" pattern="^[0-9]+$" style="width: 120px;" required>
            <br>※半角数字で入力してください。
        </div>
        `,
        required: true,
        button_label: '次へすすむ',
        on_finish: function(data) {
          // 参加者IDをjsPsychのデータストアに保存
          jsPsych.data.addProperties({participant_id: data.response.participant_id});
        }
      };


// ucla_ls //
      const ucla_ls = {
        type: jsPsychSurveyLikert,
        preamble: `
          <div class="instruction">
            <h1>日本語版UCLA 孤独感尺度</h2>
            <h2>それぞれの項目について、あなたはどのくらいの頻度で感じているかお答えください。</h2>
              あてはまるものを選択してください。</p>
          </div>
        `,
        questions: [
        '自分は周りの人たちの中になじんでいると感じますか', 
        '自分には人との付き合いがないと感じることがありますか',
        '自分には頼れる人が誰もいないと感じることがありますか', 
        '自分はひとりぼっちだと感じることがありますか',
        '自分は友人や仲間のグループの一員だと感じることがありますか', 
        '自分は周りの人たちと共通点が多いと感じることがありますか',
        '自分は誰とも親しくしていないと感じることはありますか', 
        '自分の関心や考えは周りの人たちにはわからないと感じることがありますか',
        '自分を社交的で親しみやすいと感じますか', 
        '自分には親しい人たちがいると感じますか',
        '自分は取り残されていると感じることがありますか', 
        '他人との関わりは意味がないと感じることがありますか',
        '自分のことを本当によく知っている人は誰もいないと感じることはありますか', 
        '自分は他の人たちから孤立していると感じることはありますか',
        '希望すれば自分と気の合う仲間は見つかると感じますか', 
        '自分を本当に理解している人がいると感じますか',
        '自分は内気であると感じますか', 
        '周りの人たちと一体感がもてないと感じることがありますか',
        '話し相手がいると感じますか', 
        '頼れる人がいると感じますか'
      ].map((prompt, index) => ({
        prompt: `<div class="instruction">${index + 1}) ${prompt}</div>`, // インデックス +1 をつけて ) を追加
        name: `ucla_ls${String(index + 1).padStart(2, '0')}`,
        labels: ['決してない', 'ほとんどない', '時々ある', '常にある'],
        required: true
      })),
        
        button_label: '次へすすむ',
        on_finish: function(data) {
          const newData = {};
          Object.keys(data.response).forEach((key, idx) => {
            const value = data.response[key];
            // 特定のインデックスの場合は逆順に変換
            if (value !== null && value !== "") {
              // reverseを定義
              if ([1, 5, 6, 9, 10, 15, 16, 19, 20].includes(idx + 1)) {
                // 逆順である場合 4, 3, 2, 1 を出力
                newData[key] = 4 - value;
              } else {
                // 通常の順序で 1, 2, 3, 4 を出力
                newData[key] = value + 1;
              }
            } else {
              newData[key] = ""; // 未回答の項目はそのまま
            }
          });
          data.response = newData; // 変換後のデータを保存
        }
      };

// ucla_ls end//


    // Start the experiment
    jsPsych.run([survey_id, ucla_ls
    ]);


    </script>
</html>